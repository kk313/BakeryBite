@{
    ViewData["Title"] = "Заказы";
    Layout = "_LayoutSecond";
}

<link rel="stylesheet" href="~/lib/bootstrap/dist/css/OrderEditor.css" />
<link rel="stylesheet" href="~/lib/toastr/toastr.min.css" />

@model List<BakeryBite.Models.Order>

<h1>Заказы</h1>

<div class="order-buttons">
    <a asp-controller="Control" asp-action="OrderEditor" class="btn btn-primary">Не завершённые заказы</a>
    <a asp-controller="Control" asp-action="OrderConfirmed" class="btn btn-primary">Подтвержденные заказы</a>
    <a asp-controller="Control" asp-action="OrderRejected" class="btn btn-primary">Отклоненные заказы</a>
</div>

@if (Model != null && Model.Count > 0)
{
    <div class="order-list">
        @foreach (var order in Model)
        {
            <div class="order-item">
                <div class="title-row">
                    <h2 class="order-title">Заказ # @order.Id</h2>
                </div>

                <div class="details-row">
                    <div>
                        <p><strong>Дата заказа:</strong> @order.OrderDate</p>
                        <p><strong>Сумма заказа:</strong> @order.TotalAmount руб.</p>
                        <p>
                            <strong>Статус заказа:</strong>
                            @if (order.IsCompleted == 1)
                            {
                                <span class="status-completed">Оформлен</span>
                            }
                            else if (order.IsCompleted == 2)
                            {
                                <span class="status-rejected">Отклонён</span>
                            }
                            else
                            {
                                <span class="status-pending">Не завершён</span>
                            }
                        </p>
                        <p><strong>Способ оплаты:</strong> @order.PaymentMethod</p>
                    </div>
                    <div>
                        <p><strong>Адрес доставки:</strong> @order.Address</p>
                        <p><strong>Номер телефона:</strong> @order.Phone</p>
                        @{
                            string recipientName = string.Empty;
                            if (order.UserId.HasValue && order.User != null)
                            {
                                recipientName = !string.IsNullOrWhiteSpace(order.User.Patronymic) && order.User.Patronymic.Trim().Length > 0
                                ? $"{order.User.Surname} {order.User.Name[0]}. {order.User.Patronymic[0]}."
                                : $"{order.User.Surname} {order.User.Name}";
                            }
                            else
                            {
                                recipientName = order.Name;
                            }
                        }
                        <p><strong>Получатель:</strong> @recipientName</p>
                        <p><strong>Подробнее:</strong> <a href="@Url.Action("OrderItems", "Control", new { orderId = order.Id })">Подробнее</a></p>
                    </div>
                </div>

                <div class="buttons-row">
                    @if (order.IsCompleted == 0)
                    {
                        <button type="button" class="btn btn-primary" onclick="updateOrderStatus(@order.Id, 1)">Отметить как оформленный</button>
                        <button type="button" class="btn btn-delete" onclick="updateOrderStatus(@order.Id, 2)">Отклонить заказ</button>
                    }
                </div>
            </div>
        }
    </div>
}
else
{
    <p>Нет не завершенных заказов.</p>
}

<script src="~/lib/jquery/jquery-3.6.0.min.js"></script>
<script src="~/lib/toastr/toastr.min.js"></script>

<script src="~/lib/jquery/jquery-3.6.0.min.js"></script>
<script src="~/lib/toastr/toastr.min.js"></script>
<link rel="stylesheet" href="~/lib/toastr/toastr.min.css" />

<script>
    toastr.options = {
        "positionClass": "toast-bottom-right",
        "timeOut": "3000",
        "progressBar": true
    };

    function updateOrderStatus(orderId, status) {
        var confirmationMessage = status === 1 ? 'Подтвердите оформление заказа?' : 'Подтвердите отмену заказа?';
        if (!confirm(confirmationMessage)) return;

        $.post('/Control/UpdateOrderStatus', { orderId: orderId, status: status })
            .done(function (response) {
                if (response.success) {
                    localStorage.setItem('toastrMessage', response.message);
                    localStorage.setItem('toastrType', 'success');
                    location.reload();
                } else {
                    toastr.error(response.message);
                }
            })
            .fail(function () {
                toastr.error('Ошибка при обновлении статуса заказа.');
            });
    }

    $(document).ready(function () {
        var toastrMessage = localStorage.getItem('toastrMessage');
        var toastrType = localStorage.getItem('toastrType');

        if (toastrMessage) {
            if (toastrType === 'success') {
                toastr.success(toastrMessage);
            } else if (toastrType === 'error') {
                toastr.error(toastrMessage);
            }
            localStorage.removeItem('toastrMessage');
            localStorage.removeItem('toastrType');
        }
    });
</script>

