@{
    ViewData["Title"] = "Корзина";
    Layout = "_LayoutSecond";
}
@model List<CartItem>
<link rel="stylesheet" href="~/lib/bootstrap/dist/css/ShoppingCart.css" />
<link rel="stylesheet" href="~/lib/toastr/toastr.min.css" />

<h1>Корзина покупок</h1>

<div class="grid-container">
    <div class="grid-item">
        @if (Model != null && Model.Count > 0)
        {
            @foreach (var item in Model)
            {
                <div class="base">
                    <div class="image">
                        <img class="product-img" src="data:image/png;base64,@item.Product.Avatar" alt="">
                    </div>
                    <div class="text">
                        <p class="product-name">@item.Product.Name</p>
                        <p class="product-quantity">
                            Количество: <input type="number" id="quantity-@item.Product.Id" value="@item.Quantity" min="0" data-initial-quantity="@item.Quantity" onchange="changeQuantityManual(@item.Product.Id, this.value)">
                        </p>
                    </div>
                    <p class="product-price">Цена: @item.Product.Cost руб.</p>
                    <div class="quantity-buttons">
                        <button type="button" class="add-button" onclick="changeQuantity(@item.Product.Id, 1)">+</button>
                        <button type="button" class="remove-button" onclick="changeQuantity(@item.Product.Id, -1)">-</button>
                    </div>
                </div>
            }
        }
        else
        {
            <p>Ваша корзина пуста.</p>
        }
    </div>

    @if (Model != null && Model.Count > 0)
    {
        <div class="cart-summary">
            <h3>Итоговая информация</h3>
            <p>Количество товаров: <span id="total-quantity">@Model.Sum(item => item.Quantity)</span></p>
            <p>Итоговая стоимость: <span id="total-cost">@Model.Sum(item => item.Quantity * item.Product.Cost)</span> руб.</p>
            <form method="post" asp-controller="Home" asp-action="OrderConfirmation">
                <button type="submit" class="checkout-button">Оформить заказ</button>
            </form>
        </div>
    }
</div>

<script src="~/lib/jquery/jquery-3.6.0.min.js"></script>
<script src="~/lib/toastr/toastr.min.js"></script>

<script src="~/lib/jquery/jquery-3.6.0.min.js"></script>
<script src="~/lib/toastr/toastr.min.js"></script>

<script>
    toastr.options = {
        "positionClass": "toast-bottom-right",
        "timeOut": "3000",
        "progressBar": true
    };

    function updateCartItemUI(productId, newQuantity, totalQuantity, totalCost) {
        var quantityElement = $('#quantity-' + productId);

        if (newQuantity > 0) {
            quantityElement.val(newQuantity);
        } else {
            quantityElement.closest('.base').remove();
        }

        $('#total-quantity').text(totalQuantity);
        $('#total-cost').text(totalCost);
    }

    function sendChangeQuantityRequest(productId, change, newQuantity = -1) {
        $.ajax({
            url: '/Home/ChangeCartItemQuantity',
            type: 'POST',
            data: { productId: productId, change: change, newQuantity: newQuantity },
            success: function (data) {
                if (data.reload) {
                    location.reload();
                } else {
                    updateCartItemUI(productId, data.itemQuantity, data.totalQuantity, data.totalCost);
                    if (data.itemQuantity === 0) {
                        toastr.success('Товар удалён из корзины!', '', { timeOut: 2000 });
                    } else {
                        toastr.success('Количество товара в корзине успешно обновлено!', '', { timeOut: 2000 });
                    }
                }
            },
            error: function () {
                toastr.error('Ошибка при изменении количества товара в корзине.');
            }
        });
    }

    function changeQuantity(productId, change) {
        var quantityElement = $('#quantity-' + productId);
        var currentQuantity = parseInt(quantityElement.val());
        var newValue = currentQuantity + change;

        if (newValue < 0) {
            alert('Количество товара не может быть меньше 0.');
            return;
        }

        if (newValue === 0) {
            if (!confirm('Вы уверены, что хотите удалить этот товар из корзины?')) {
                return;
            }
        }

        sendChangeQuantityRequest(productId, change);
    }

    function changeQuantityManual(productId, value) {
        var newValue = parseInt(value);

        if (isNaN(newValue) || newValue < 0) {
            alert('Количество должно быть числом больше или равным 0.');
            return;
        }

        if (newValue === 0) {
            if (!confirm('Вы уверены, что хотите удалить этот товар из корзины?')) {
                var quantityElement = $('#quantity-' + productId);
                quantityElement.val(quantityElement.data('initial-quantity'));
                return;
            }
        }

        sendChangeQuantityRequest(productId, 0, newValue);
    }

    function removeItemFromCart(productId) {
        if (!confirm('Вы уверены, что хотите удалить этот товар из корзины?')) {
            return;
        }

        sendChangeQuantityRequest(productId, 0, 0);
    }
</script>
