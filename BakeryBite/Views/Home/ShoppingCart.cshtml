@{
    ViewData["Title"] = "Корзина";
    Layout = "_LayoutSecond";
}
@model List<CartItem>
<link rel="stylesheet" href="~/lib/bootstrap/dist/css/ShoppingCart.css" />
<h1>Корзина покупок</h1>

<div class="grid-container">
    <div class="grid-item">
        @if (Model != null && Model.Count > 0)
        {
            @foreach (var item in Model)
            {
                <div class="base">
                    <div class="image">
                        <img class="product-img" src="data:image/png;base64,@item.Product.Avatar" alt="">
                    </div>
                    <div class="text">
                        <p class="product-name">@item.Product.Name</p>
                        <p class="product-quantity">Количество: <span id="quantity-@item.Product.Id">@item.Quantity</span></p>
                    </div>
                    <p class="product-price">Цена: @item.Product.Cost руб.</p>
                    <div class="quantity-buttons">
                        <button type="button" class="add-button" onclick="changeQuantity(@item.Product.Id, 1)">+</button>
                        <button type="button" class="remove-button" onclick="changeQuantity(@item.Product.Id, -1)">-</button>
                    </div>
                </div>
            }
        }
        else
        {
            <p>Ваша корзина пуста.</p>
        }
    </div>

    @if (Model != null && Model.Count > 0)
    {
        <div class="cart-summary">
            <h3>Итоговая информация</h3>
            <p>Количество товаров: <span id="total-quantity">@Model.Sum(item => item.Quantity)</span></p>
            <p>Итоговая стоимость: <span id="total-cost">@Model.Sum(item => item.Quantity * item.Product.Cost)</span> руб.</p>
            <form method="post" asp-controller="Home" asp-action="OrderConfirmation">
                <button type="submit" class="checkout-button">Оформить заказ</button>
            </form>
        </div>
    }
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function changeQuantity(productId, change) {
        var quantityElement = $('#quantity-' + productId);
        var currentQuantity = parseInt(quantityElement.text());

        if (currentQuantity === 1 && change === -1) {
            if (!confirm('Вы уверены, что хотите удалить этот товар из корзины?')) {
                return; 
            }
        }

        $.ajax({
            url: '@Url.Action("ChangeCartItemQuantity", "Home")',
            type: 'POST',
            data: { productId: productId, change: change },
            success: function (data) {
                $('#total-quantity').text(data.totalQuantity);
                $('#total-cost').text(data.totalCost);

                var quantity = data.itemQuantity;

                if (quantity <= 0) {
                    quantityElement.closest('.base').remove();
                } else {
                    quantityElement.text(quantity);
                }

                if (data.totalQuantity <= 0) {
                    location.reload();
                }
            },
            error: function () {
                alert('Ошибка при изменении количества товара в корзине.');
            }
        });
    }
</script>